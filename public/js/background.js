function e(e){e?(n("stop"),r("Stop reading")):t()}function t(){n("default"),r("Read aloud selected text")}function n(e){const t={path:`images/${e}.svg`};chrome.browserAction.setIcon(t)}function r(e){chrome.browserAction.setTitle({title:e})}t();const o=/[-_.,:;!?<>\/()â€”[\]{}]/gm,c=new class{constructor(){this.counter=0}increment(){this.counter+=1,this.checkSpeakingState()}decrement(){this.counter-=1,this.checkSpeakingState()}reset(){this.counter=0,this.updateText()}checkSpeakingState(){chrome.tts.isSpeaking(e=>{e?this.updateText():this.reset()})}updateText(){chrome.browserAction.setBadgeText({text:`${0===this.counter?"":this.counter}`})}},s={pitch:0,volume:1,rate:1.5,lang:"en-GB",enqueue:!0,onEvent:t=>{chrome.tts.isSpeaking(t=>e(t)),"error"===t.type?h(`Error: ${t.errorMessage}`):"end"===t.type&&c.decrement()}};function i(){chrome.storage.sync.get(["pitch","rate","lang"],e=>{s.rate=e.rate,s.pitch=e.pitch,s.lang=e.lang,console.log(`Pitch: ${e.pitch}, Rate: ${e.rate}, Lang: ${e.lang}`)})}function a(e,t=s){e.split(o).map(e=>e.trim()).filter(e=>e.length).forEach(e=>(function(e,t){chrome.tts.speak(e,t,()=>{chrome.runtime.lastError&&h(`Error: ${chrome.runtime.lastError.message}`)}),c.increment()})(e,t))}function h(e){u(),console.error(e)}function u(){chrome.tts.stop(),c.reset()}chrome.runtime.onInstalled.addListener(()=>{chrome.storage.sync.set({pitch:0,rate:1.5,lang:"en-GB"},()=>{console.log("Read Aloud: On Installed")})}),chrome.runtime.onStartup.addListener(()=>{console.log("Read Aloud: On Startup"),i()}),chrome.storage.onChanged.addListener((e,t)=>{console.log("Read Aloud: On Settings Changed"),i()});const d="read-aloud-selected-text";function m(){chrome.tabs.query({active:!0,currentWindow:!0},e=>{const t=e[0].id||-1;return t&&chrome.tabs.sendMessage(t,{query:"GET_SELECTION"}),!0})}chrome.commands.onCommand.addListener(function(e){e===d&&m()}),chrome.browserAction.onClicked.addListener(function(e){chrome.tts.isSpeaking(e=>{e?u():m()})}),chrome.runtime.onMessage.addListener(function(e,t,n){if(t.id!==chrome.runtime.id)return!0;"READ_SELECTION"===e.message&&a(e.selection);return!0});
