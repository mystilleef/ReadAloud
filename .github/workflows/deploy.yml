# .github/workflows/deploy.yml

name: Deploy to Chrome Web Store

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm install

      - name: Build Extension
        run: npm run build

      - name: Create secrets directory
        run: mkdir -p secrets

      - name: Create service account key file
        run: echo '${{ secrets.SERVICE_ACCOUNT_KEY }}' > secrets/service-account-key.json

      - name: Create service account config
        run: |
          cat > secrets/service-account-config.json <<EOF
          {
            "type": "service_account",
            "publisherId": "${{ secrets.CHROME_PUBLISHER_ID }}",
            "extensionId": "${{ secrets.CHROME_EXTENSION_ID }}",
            "serviceAccountKeyPath": "./secrets/service-account-key.json"
          }
          EOF

      - name: Deploy to Chrome Web Store
        run: npm run deploy

      - name: Clean up secrets
        if: always()
        run: |
          rm -rf secrets/
